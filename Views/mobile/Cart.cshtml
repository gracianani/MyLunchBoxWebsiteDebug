﻿@model MyLunchBox.Models.ShoppingCart
@{
    ViewBag.Title = "Cart";
    Layout = "~/Views/Shared/_MobileMaster.cshtml";
}

<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script type="text/javascript">
    $(function () {
        bindRemove();

        $(".cart-quantity").change(function () {
            var ipt = $(this);
            var qty = parseInt(ipt.val());

            if (qty < 1) {
                ipt.val(1);
                qty = 1;
            }
            var itemId = ipt.attr('data-itemId');
            var itemTypeId = ipt.attr('data-itemTypeId');
            $.post("/ShoppingCart/ChangeQuantity/", { "itemId": itemId, "itemTypeId": itemTypeId, "quantity": qty },
        		function (data) {
        		    var tr = $("tr[data-itemId='" + itemId + "']");
        		    var unitPrice = parseFloat(tr.find('.cart-unitPrice').attr('data-price'));

        		    var totalPrice = Math.round(unitPrice * qty * 100) / 100;
        		    tr.find('.cart-totalPrice').html('$' + totalPrice);

        		    setSubtotalPrice(data.gross);

        		});

        });

        $('.btn-submit').click(function (e) {
            e.preventDefault();
            $(this).attr('disabled', 'true');

            $('<div style="position:fixed;left:0;top:0;padding-top:20%;height:80%;width:100%;background-color:rgba(0,0,0,0.6);color:#FFF;z-index:999;text-align:center;display:none"><img src="../../Content/Images/ajax-loader.gif" style="vertical-align:top" /> Processing...</div>').appendTo($('.page')).fadeIn();

            window.location.href = $(this).attr('href');

        });
    });

    function setSubtotalPrice(price) {
        $('.cart-subtotalPrice').html('$' + price);
    }

    function bindRemove() {
        $(".removeItem").click(function () {
            var itemId = $(this).attr("data-itemId");
            var itemTypeId = $(this).attr('data-itemTypeId');
            if (itemId != '') {
                $.post("/ShoppingCart/RemoveItem/", { "itemId": itemId, "itemTypeId": itemTypeId },
                    function (data) {
                        setSubtotalPrice(data.gross);
                        window.location.reload();
                    });
            }
        });
    }
</script>
<div data-role="content">
@using (Html.BeginForm()) {
    @Html.ValidationSummary(true)

    <ul class="createBentoProgress">
            <li>
            <span class="ui-icon ui-icon-check">&nbsp;</span>
            <a class="prev" href="/CustomBentoBox/ChooseRestaurant/">Restaurant</a>  &raquo; </li>
            <li>
            <span class="ui-icon ui-icon-check">&nbsp;</span>
            <a class="prev">LunchBox</a> &raquo; </li>
            <li>
            <span class="ui-icon ui-icon-edit">&nbsp;</span>
            <a class="current">Dishes</a> &raquo;</li>
            <li><a>CheckOut</a></li>
    </ul>
    <h3>My Shopping Cart</h3>
    <fieldset>
        <div style="display:none;">
        	@Html.HiddenFor(model => model.ShoppingCartId)
            @Html.LabelFor(model => model.UserId)
            @Html.EditorFor(model => model.UserId)
            @Html.ValidationMessageFor(model => model.UserId)
        </div>
        <table id="shoppingCartItems" class="lightBox" data-mode="columntoggle" data-role="table">
            @if (Model.ShoppingCartItems.Count == 0)
            {
                <tr><td><img src="../Content/Images/emptybox.png" /></td>
                <td><div style="padding-top:50px;">Your Cart is empty! Go @Html.ActionLink("create a lunchbox", "ChooseRestaurant", "CustomBentoBox", new Object{}, new { @class = "em"} ) now!</div></td></tr>
            }
            else {
            	<thead>
            	<tr>
            	<th>Details</th>
            	<th data-priority="1">Unit Price</th>
            	<th>Quantity</th>
            	<th>Total Price</th>
                <th></th>
            	</tr>
                </thead>
                <tbody>
                @foreach (var shoppingCartItem in Model.ShoppingCartItems)
                {
                    <tr data-itemId='@shoppingCartItem.ItemId' data-itemTypeId='@shoppingCartItem.ItemTypeId'>
                        <td >
                        	@if(@shoppingCartItem.ItemTypeId == (int)MyLunchBox.Models.ItemType.CustomBentoBox) {
                                <p class="cart-boxType">@shoppingCartItem.CustomBentoBox.BentoBox.BentoBoxName @Html.ActionLink("edit", "Create", "CustomBentoBox",  new { customBentoBoxId = @shoppingCartItem.ItemId }, new {@class="edit-link",@data_role="button",@data_mini="true",@data_icon="edit",@data_inline="true",@data_iconPos="notext"} )</p>
                            }
                            else {
                                <p>@shoppingCartItem.Description</p>    
                            }
                            @if( shoppingCartItem.ItemTypeId == (int)MyLunchBox.Models.ItemType.CustomBentoBox) {
                                <ul class="cart-dishList">
                                @foreach(var customItem in shoppingCartItem.CustomBentoBox.CustomBentoBoxItems) {
                                    <li> <img src="/@customItem.Dish.DishImageUrl" style="width:30px"/> <span>@customItem.Dish.DishName
                                
	                            @if (true) {
	                           		<text> x @customItem.Quantity </text> 
	                            }
                                    </span> </li>
                                }
                                </ul>
                                
                            }
                            
                        </td>
                        <td class="cart-unitPrice" data-price="@shoppingCartItem.LineItemCost">
	                     $@shoppingCartItem.UnitPrice
                        </td>
                        <td>
	                      <input value="@shoppingCartItem.Quantity" type="number" class="cart-quantity" data-itemId='@shoppingCartItem.ItemId' data-itemTypeId='@shoppingCartItem.ItemTypeId' />
                        </td>
                        <td class="cart-totalPrice">
                        $@shoppingCartItem.LineItemCost
                        </td>
                        <td>
                        <a class="removeItem delete-link" data-role="button" data-icon="delete" href="javascript:void(0)" data-itemId='@shoppingCartItem.ItemId' data-mini="true" data-inline="true" data-iconPos="notext">Delete</a>
                        </td>
                    
                        </tr>
                }
                </tbody>
                <tfoot>
                <tr><td></td><td></td><td>Shipping</td><td>@Model.Shipping</td><td></td></tr>
                <tr><td></td><td></td><td class="cart-subtotal"><div class="pull-right">Subtotal</div></td><td class="cart-subtotalPrice big"> $@Model.Gross</td><td></td></tr>
               </tfoot>
               
            }
		
        </table>

       
    </fieldset>
    
}

<div class="clearfix">
@if (Model.ShoppingCartItems.Count > 0) {
    @Html.ActionLink("Continue Shopping", "ChooseRestaurant", "Mobile",new object { },
new { @class = "btn pull-left"})
    @Html.ActionLink("Checkout »", "Checkout", "Mobile", new object { },
new { @class = "btn btn-primary pull-right btn-big btn-submit"})
}
</div>
</div>
